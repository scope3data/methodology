---
title: "Inference Service"
description: "Methodology for calculating the impact of managing an AI inference service"
---

## Overview

Inference, or using the models to get responses to user prompts, uses less energy each session, but eventually involves many more sessions. An â€œinference serviceâ€ is a service that exposes a single model for inference. This service will be hosted on a cluster of servers or cloud instances, potentially with reserved capacity and the ability to auto-scale with volume.

Sometimes these models are only trained once, and then deployed to the cloud and used by millions of users for inference. In that case, deploying large deep-learning models to the cloud for inference purposes also consumes a lot of energy.Â AnalystsÂ [report](https://www.forbes.com/sites/moorinsights/2019/05/09/google-cloud-doubles-down-on-nvidia-gpus-for-inference/?sh=7aa7fce46792)Â that NVIDIA estimates that 80â€“90% of the energy cost of neural networks lies in ongoing inference processing after a model has been trained.

Model:
- The base model used including the current [amortized training cost per inference](/training#amortization-of-impact-across-use-life)
- The current [amortized fine-tuning cost per inference](/fine_tuning#amortization-of-fine-tuning-impact-across-use-life) if applicable

Cluster data:
- [Cluster](/cluster) details
- Cluster location(s) - if hosted in a cloud, which region(s)
- Cluster throughput (per server/instance if autoscaling)

## Activity data

The activity of the inference service should be provided on an hourly basis to map to grid intensity from renewables:
- Date and time, aggregated by hour
- Cluster size (as multiple of base cluster)
- Average CPU and GPU utilization
- Use case
- For key parameters (see below by use case)
  - Number of requests
  - Request latency (or other proxy for computation)

### Image parameters
- Input and output size
- Output quality
- LoRA models used

LoRA model training can be modeled using the same methodology as full models.

### Text generation / chat parameters
- Input tokens
- Output tokens

## Calculating emissions and water usage

For a given hour:
```
usage emissions = (cluster size) x E(gpu%, cpu%) x (datacenter PUE) x (average grid intensity)

embodied emissions = (cluster size) x EmbEm(1)

inference emissions = (usage emissions) + (embodied emissions)

water usage = (cluster size) x E(gpu%, cpu%) x (cluster WUE)

embodied water usage = (cluster size) x EmbH2O(1)

inference water = (water usage) + (embodied water usage)
```

The emissions per request includes the amortized training for the base model and any add-ons (like LoRA) and fine-tuning emissions:
```
Em(inference) = sum(amortized training emissions) + (amortized fine-tuning emissions) +
                        (inference emissions)

H2O(inference) = sum(amortized training water) + (amortized fine-tuning water) +
                        (inference water)
```

## Various research findings

To model inference requires understanding the emissions per inference for a model on a particular host given certain parameters. There are *many* factors that determine how a model is executed including [batching strategies](https://www.anyscale.com/blog/continuous-batching-llm-inference#continuous-batching), [paged attention](https://blog.vllm.ai/2023/06/20/vllm.html), and optimizations like quantization. The intention of this methodology is to provide a framework that both calculates and predicts the emissions cost of inference with the flexibility to include future optimizations as they appear.

Inference speed may be limited by the framework or by compute. Maximum performance will be achieved when models are not limited by [framework overhead](https://arxiv.org/pdf/2302.06117).  In an optimal scenario, inference can use the full capacity and power of a GPU, as described by [Towards Pareto Optimal Throughput in Small Language Model Serving](https://arxiv.org/pdf/2404.03353). 

Per Wilkins, Keshav, Mortier (2024) [Offline Energy-Optimal LLM Serving](https://arxiv.org/pdf/2407.04014), The number of input tokens and number of output tokens both individually have a substantial impact on energy consumption and runtime, with output tokens having a larger effect size as indicated by the higher ğ¹ statistic. Also, the interaction term shows that the input and output tokens depend on each other while impacting en- ergy consumption and runtime.

We therefore propose a model to describe the total energy consumption for a model ğ¾ as a function of input and output tokens, ğœğ‘–ğ‘› and ğœğ‘œğ‘¢ğ‘¡ , respectively:
ğ‘’ğ¾ (ğœğ‘–ğ‘›, ğœğ‘œğ‘¢ğ‘¡ ) = ğ›¼ğ¾,0ğœğ‘–ğ‘› + ğ›¼ğ¾,1ğœğ‘œğ‘¢ğ‘¡ + ğ›¼ğ¾,2ğœğ‘–ğ‘›ğœğ‘œğ‘¢ğ‘¡

This model has high explainability for the effect of input and output tokens on energy and runtime for inference of these different LLMs.
